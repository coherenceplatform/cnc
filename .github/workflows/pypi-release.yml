name: PyPI Release

on:
  release:
    types: [ published ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install build dependencies
      run: |
          python3 -m pip install --upgrade build twine toml

    - name: Set package version and create artifact
      run: |
        PACKAGE_VERSION=${GITHUB_REF#refs/tags/}
        echo "PACKAGE_VERSION=$PACKAGE_VERSION" >> $GITHUB_ENV
        echo $PACKAGE_VERSION > version.txt
        sed -i "s/^version = .*/version = \"$PACKAGE_VERSION\"/" pyproject.toml

    - name: Upload version as artifact
      uses: actions/upload-artifact@v2
      with:
        name: version
        path: version.txt

    - name: Check if version already exists on PyPI
      run: |
        PACKAGE_NAME=cocnc
        PACKAGE_VERSION=${{ env.PACKAGE_VERSION }}
        VERSION_EXISTS=$(curl -s https://pypi.org/pypi/${PACKAGE_NAME}/json | python3 -c "import sys, json; data = json.load(sys.stdin); print('${PACKAGE_VERSION}' in data['releases'])")
        echo "VERSION_EXISTS=$VERSION_EXISTS" >> $GITHUB_ENV

    - name: Build the package
      if: env.VERSION_EXISTS == 'False'
      run: |
        python3 -m build

    - name: Publish to PyPI
      if: env.VERSION_EXISTS == 'False'
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.PYPI_TOKEN }}
      run: |
        python3 -m twine upload dist/*
